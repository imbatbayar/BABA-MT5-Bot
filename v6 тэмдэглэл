БАВА, ойлгомжтой тайлбар + дараагийн цонход хэрэглэх “шар тэмдэглэл”-ээ бэлдлээ. Гол нь: V6 арилжаа нь оны төгсгөл хавьд хэд нээчихээд таг болсон шалтгаан бол манай “loss дараах cooldown” тооцоолол. Доорх тэмдэглэл + яг хаанаас‑хаана солих PATCH-уудыг үлдээнэ.

Товч дүгнэлт

Юу болсон? Loss гарсны дараа Cooldown хамгаалалт маань “үргэлж идэвхтэй” болж, RiskGuard арилжааг бүрэн хаасан.

Яагаад? Cooldown‑ийн тоолуурт бид iBarShift(..., TimeCurrent()) хэрэглэсэн. Энэ нь одоо бар‑ын индексийг үргэлж 0 гэж буцаадаг тул curBar - lastExitBar < InpCooldownBarsLoss нөхцөл үргэлж үнэн хэвээр үлдсэн.

Нэмэлтээр нөлөөлсөн байж болох: InpMaxTradesPerDay, InSession (цагийн шүүлт), CounterScalpGuard зэрэг гейтүүд, гэхдээ гол гацаа нь Cooldown.

Энэ цонхонд хийсэн гол сайжруулалтууд

Mode (Auto/Range/Trend) + Counter‑Scalp Guard — трендийн эсрэг богино scalp‑ийг хориглосон.

Day limits & Session — өдөрт нээх гүйлгээ, ажиллах цагийн хүрээ.

Fake Breakout 2/3 шалгалт — wick/body/volume z‑score.

RR≥1:2 gate, Partial TP + BE, ATR trail — Balanced Preset 1%/trade.

Илэрсэн алдаанууд (энэ цонхонд)

TimeDayOfWeek() ашигласан → MQL5‑д байхгүй (зассан: WeekdayOf() туслах).

iVolume() → long‑оос double руу warning (зассан: ил тод cast).

Cooldown Bug (үндсэн гацаа) → барын индексийг буруу авсан тул loss‑ын дараа арилжаа бүрэн OFF болсон.

PATCH — Cooldown алдааг засах (ЯГ ХААНД НЭМ/СОЛИХ)

Доорх 3 газрыг л өөрчлөхөд хангалттай.

1) Төлөв хувиргагч хувьсагчийг шинэчил
Хайж ол:
bool  lastExitWasLoss=false;
int   lastExitBar= -99999;
double lastEntryPrice=0.0;

Доорх хэлбэрээр сол:
bool  lastExitWasLoss = false;
int   lastExitBarIndex = -100000;   // Bars() индекс хадгална
double lastEntryPrice = 0.0;

2) RiskGuardAllows() доторх Cooldown шалгалтыг солих
Хайж ол (RiskGuardAllows() дотор):
int curBar = iBarShift(_Symbol,InpTF,TimeCurrent());
if(lastExitWasLoss && curBar - lastExitBar < InpCooldownBarsLoss) return false;

Дээрх 2 мөрийг ингэж соли:
int curIdx = BarsTF(InpTF);
if(lastExitWasLoss && (curIdx - lastExitBarIndex) < InpCooldownBarsLoss) return false;

3) lastExitBar‑ыг хаана хаадаг тэр хэсгүүдэд Bars индексээр хадгал
A) ManageOpen() дотор time‑stop‑оор хаах хэсгийг хай:
if(barsSince >= InpTimeStopBars) {
   double balBefore = AccountInfoDouble(ACCOUNT_EQUITY);
   if(Trade.PositionClose(tk)){
      lastExitWasLoss = (AccountInfoDouble(ACCOUNT_EQUITY) < balBefore);
      lastExitBar = iBarShift(_Symbol,InpTF,TimeCurrent());
   }
}

Дээрхийг ингэж соли:
if(barsSince >= InpTimeStopBars) {
   double balBefore = AccountInfoDouble(ACCOUNT_EQUITY);
   if(Trade.PositionClose(tk)){
      lastExitWasLoss  = (AccountInfoDouble(ACCOUNT_EQUITY) < balBefore);
      lastExitBarIndex = BarsTF(InpTF);
   }
}

B) OnBreakoutConfirm() дотор оролдлого бүтэлгүйтвэл хадгалдаг хэсгийг хай:
}else{
   lastExitWasLoss = (AccountInfoDouble(ACCOUNT_EQUITY) < balBefore);
   lastExitBar = iBarShift(_Symbol,InpTF,TimeCurrent());
   Transition(ST_RANGE);
}

Дээрхийг ингэж соли:
}else{
   lastExitWasLoss  = (AccountInfoDouble(ACCOUNT_EQUITY) < balBefore);
   lastExitBarIndex = BarsTF(InpTF);
   Transition(ST_RANGE);
}


Ийм өөрчлөлт хийснээр loss‑ын дараах амралтын барын тоо зөв ажиллана (жишээ: InpCooldownBarsLoss=5 бол яг 5 шинэ бар өнгөртөл RiskGuard хаана).

Нэмэлт зөвлөмж (арилжаа “таг” болохоос сэргийлэх)

InpMaxTradesPerDay=10 → эхлээд 6–8 болгоод equity‑г ажигла.

InSession (07–22 сервер цаг) — өдрийн төгсгөл, баярын үед сигнал цөөрөх нь хэвийн. Хэрэв тест чинь D1 таб дээр явж байгаа бол ч гэвч EA доторх InpTF = M5 тул шинэ бар бүрт ажиллана.

InpMinSeasonWeight=0.90 — хэрэв оролт багадвал 0.85 болгож сулруулж болно.

InpConfirmBars=2 — баярын үеийн нимгэн зах зээл дээр 1 болгож турш.

Дараагийн цонхонд ашиглах богино “тэмдэглэл”

V6 Balanced 1%: Mode=Auto, CounterScalpGuard=ON, Cooldown=5 bar, DayLossCap=2%, RR≥2.

Сүүлд илэрсэн critical bug: Cooldown барын индекс. (PATCH хийсэн — lastExitBarIndex ашиглана.)

Шалгах 4 метрик: PF≥1.5, MaxDD≤15%, Win≈50–55%, AvgR≈1.8–2.0.

Тестийн журам: Visual (M5/M15) 6–12 сар → дараа нь Demo forward 1–2 долоо хоног.

Тохируулгын хөшүүрэг: InpDonchLookback, InpATR_Mult, InpATR_Trail_Mult, InpConfirmBars, InpMinTouches.

Хэрвээ хүсвэл би дээрх PATCH‑ийг бүхэл файл дээр чинь шингээсэн V6.1 хувилбарыг энд шууд бүрэн貼‑ээд өгье
